<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" routerLink="/">RentDrive</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" routerLink="/catalogo">Catálogo</a></li>
        <li class="nav-item"><a class="nav-link" routerLink="/login">Cerrar Sesión</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-5">
  <div class="row">

    <!-- Información personal -->
    <div class="col-lg-4 mb-4">
      <div class="card shadow-sm perfil-card">
        <div class="card-header bg-primary text-white text-center">
          <h5><i class="fa-solid fa-user"></i> Información Personal</h5>
        </div>
        <div class="card-body">
          <p><i class="fa-solid fa-id-card me-2"></i><strong>Nombre:</strong> {{ cliente.nombre }}</p>
          <p><i class="fa-solid fa-id-card me-2"></i><strong>Apellido:</strong> {{ cliente.apellido }}</p>
          <p><i class="fa-solid fa-envelope me-2"></i><strong>Correo:</strong> {{ cliente.email }}</p>
          <p><i class="fa-solid fa-phone me-2"></i><strong>Teléfono:</strong> {{ cliente.telefono }}</p>
          <p><i class="fa-solid fa-passport me-2"></i><strong>Documento:</strong> {{ cliente.dni }}</p>
        </div>
      </div>
    </div>

    <!-- Historial de reservas / pagos -->
    <div class="col-lg-8">
      <ul class="nav nav-tabs mb-3" id="historialTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="reservas-tab" data-bs-toggle="tab" data-bs-target="#reservas"
            type="button" role="tab">
            <i class="fa-solid fa-car"></i> Reservas
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="pagos-tab" data-bs-toggle="tab" data-bs-target="#pagos" type="button" role="tab">
            <i class="fa-solid fa-money-bill"></i> Pagos
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- Tab Reservas -->
        <div class="tab-pane fade show active" id="reservas" role="tabpanel">
          <div class="card shadow-sm historial-card">
            <div class="card-body p-2">
              <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                  <tr>
                    <th>Vehículo</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>Costo</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let reserva of reservas">
                    <td><i class="fa-solid fa-car me-1"></i> {{ getVehiculoInfo(reserva) }}</td>
                    <td>{{ reserva.fechaInicio }}</td>
                    <td>{{ reserva.fechaFin }}</td>
                    <td>S/ {{ reserva.costoEstimado || 0 }}</td>
                    <td>
                      <span class="badge" [ngClass]="{
                        'bg-success': isPagado(reserva),
                        'bg-warning text-dark': !isPagado(reserva)
                      }">
                        {{ reserva.estado }}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-info btn-sm me-1" (click)="verReserva(reserva)" title="Ver Reserva">
                        <i class="fa-solid fa-eye"></i>
                      </button>
                      <button class="btn btn-success btn-sm me-1" (click)="abrirPagoModal(reserva)"
                        *ngIf="!isPagado(reserva)" title="Pagar">
                        <i class="fa-solid fa-credit-card"></i>
                      </button>
                      <button class="btn btn-danger btn-sm" (click)="cancelarReserva(reserva)"
                        *ngIf="!isPagado(reserva)" title="Cancelar">
                        <i class="fa-solid fa-ban"></i>
                      </button>
                    </td>
                  </tr>
                  <tr *ngIf="reservas.length === 0">
                    <td colspan="6" class="text-center text-muted">No hay reservas registradas</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Tab Pagos -->
        <div class="tab-pane fade" id="pagos" role="tabpanel">
          <div class="card shadow-sm historial-card">
            <div class="card-body p-2">
              <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                  <tr>
                    <th>ID Pago</th>
                    <th>Monto</th>
                    <th>Método</th>
                    <th>Referencia</th>
                    <th>Fecha</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let pago of pagos">
                    <td>{{ pago.idPago }}</td>
                    <td>S/ {{ pago.monto }}</td>
                    <td>{{ pago.metodoPago }}</td>
                    <td>{{ pago.referencia || '-' }}</td>
                    <td>{{ pago.fechaPago }}</td>
                  </tr>
                  <tr *ngIf="pagos.length === 0">
                    <td colspan="5" class="text-center text-muted">No hay pagos registrados</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- ========== MODAL VER RESERVA ========== -->
<div class="modal-overlay" *ngIf="showVerReservaModal" (click)="cerrarVerReservaModal()">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header bg-info text-white">
      <h5><i class="fa-solid fa-eye me-2"></i>Detalle de Reserva</h5>
      <button class="btn-close btn-close-white" (click)="cerrarVerReservaModal()"></button>
    </div>
    <div class="modal-body" *ngIf="reservaSeleccionada">
      <div class="row">
        <!-- Info Reserva -->
        <div class="col-md-6">
          <h6 class="text-primary mb-3"><i class="fa-solid fa-calendar me-2"></i>Información de Reserva</h6>
          <p><strong>ID Reserva:</strong> {{ reservaSeleccionada.idReserva }}</p>
          <p><strong>Fecha de Reserva:</strong> {{ reservaSeleccionada.fechaReserva | date:'dd/MM/yyyy HH:mm' }}</p>
          <p><strong>Fecha Inicio:</strong> {{ reservaSeleccionada.fechaInicio }}</p>
          <p><strong>Fecha Fin:</strong> {{ reservaSeleccionada.fechaFin }}</p>
          <p><strong>Días de Alquiler:</strong> {{ calcularDias() }} días</p>
          <p><strong>Costo Estimado:</strong> <span class="text-success fw-bold">S/ {{ reservaSeleccionada.costoEstimado
              || 0 }}</span></p>
          <p><strong>Estado:</strong>
            <span class="badge" [ngClass]="{
              'bg-success': isPagado(reservaSeleccionada),
              'bg-warning text-dark': !isPagado(reservaSeleccionada)
            }">{{ reservaSeleccionada.estado }}</span>
          </p>
          <p><strong>Método Entrega:</strong> {{ reservaSeleccionada.metodoEntrega || 'No especificado' }}</p>
          <p *ngIf="reservaSeleccionada.direccionEntrega"><strong>Dirección:</strong> {{
            reservaSeleccionada.direccionEntrega }}</p>
        </div>

        <!-- Info Vehículo -->
        <div class="col-md-6">
          <h6 class="text-primary mb-3"><i class="fa-solid fa-car me-2"></i>Información del Vehículo</h6>
          <ng-container *ngIf="reservaSeleccionada.vehiculo">
            <p><strong>Marca:</strong> {{ reservaSeleccionada.vehiculo.marca || 'N/A' }}</p>
            <p><strong>Modelo:</strong> {{ reservaSeleccionada.vehiculo.modelo || 'N/A' }}</p>
            <p><strong>Año:</strong> {{ reservaSeleccionada.vehiculo.anio || 'N/A' }}</p>
            <p><strong>Placa:</strong> {{ reservaSeleccionada.vehiculo.placa || 'N/A' }}</p>
            <p><strong>Color:</strong> {{ reservaSeleccionada.vehiculo.color || 'N/A' }}</p>
            <p><strong>Combustible:</strong> {{ reservaSeleccionada.vehiculo.combustible || 'N/A' }}</p>
            <p><strong>Precio/Día:</strong> S/ {{ reservaSeleccionada.vehiculo.precioDiario || 0 }}</p>
          </ng-container>
          <ng-container *ngIf="!reservaSeleccionada.vehiculo">
            <p class="text-muted">Información del vehículo no disponible</p>
          </ng-container>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarVerReservaModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ========== MODAL PAGAR ========== -->
<div class="modal-overlay" *ngIf="showPagoModal" (click)="cerrarPagoModal()">
  <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header bg-success text-white">
      <h5><i class="fa-solid fa-credit-card me-2"></i>Procesar Pago</h5>
      <button class="btn-close btn-close-white" (click)="cerrarPagoModal()"></button>
    </div>
    <div class="modal-body" *ngIf="reservaSeleccionada">
      <!-- Resumen de la reserva -->
      <div class="resumen-pago mb-4">
        <h6 class="text-primary"><i class="fa-solid fa-receipt me-2"></i>Resumen de Reserva</h6>
        <table class="table table-sm table-bordered">
          <tr>
            <td><strong>Vehículo:</strong></td>
            <td>{{ getVehiculoInfo(reservaSeleccionada) }}</td>
          </tr>
          <tr>
            <td><strong>Fecha Inicio:</strong></td>
            <td>{{ reservaSeleccionada.fechaInicio }}</td>
          </tr>
          <tr>
            <td><strong>Fecha Fin:</strong></td>
            <td>{{ reservaSeleccionada.fechaFin }}</td>
          </tr>
          <tr>
            <td><strong>Días:</strong></td>
            <td>{{ calcularDias() }} días</td>
          </tr>
          <tr class="table-success">
            <td><strong>Total a Pagar:</strong></td>
            <td><strong class="fs-5">S/ {{ reservaSeleccionada.costoEstimado || 0 }}</strong></td>
          </tr>
        </table>
      </div>

      <!-- Selector de método de pago -->
      <div class="metodo-pago mb-3">
        <h6 class="text-primary"><i class="fa-solid fa-wallet me-2"></i>Método de Pago</h6>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-metodo" [class.active]="metodoPagoSeleccionado === 'Yape'"
            (click)="metodoPagoSeleccionado = 'Yape'">
            <i class="fa-solid fa-mobile-screen me-2"></i>Yape
          </button>
          <button class="btn btn-metodo" [class.active]="metodoPagoSeleccionado === 'Tarjeta'"
            (click)="metodoPagoSeleccionado = 'Tarjeta'">
            <i class="fa-solid fa-credit-card me-2"></i>Tarjeta
          </button>
          <button class="btn btn-metodo" [class.active]="metodoPagoSeleccionado === 'Transferencia'"
            (click)="metodoPagoSeleccionado = 'Transferencia'">
            <i class="fa-solid fa-building-columns me-2"></i>Transferencia
          </button>
        </div>
      </div>

      <!-- ===== FORMULARIO YAPE ===== -->
      <div class="payment-form" *ngIf="metodoPagoSeleccionado === 'Yape'">
        <div class="yape-container p-3 rounded mb-3">
          <div class="text-center mb-3">
            <img src="https://www.yape.com.pe/assets/images/logo-yape.png" alt="Yape" style="height: 40px;"
              onerror="this.style.display='none'">
            <h6 class="text-purple mt-2"><i class="fa-solid fa-mobile-screen me-2"></i>Pago con Yape</h6>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label"><i class="fa-solid fa-phone me-1"></i>Número de Yape</label>
              <input type="tel" class="form-control" [(ngModel)]="yapeNumero" placeholder="999 999 999" maxlength="9">
            </div>
            <div class="col-md-6">
              <label class="form-label"><i class="fa-solid fa-key me-1"></i>Código de Aprobación</label>
              <input type="text" class="form-control" [(ngModel)]="yapeCodigo" placeholder="Código del voucher"
                maxlength="10">
            </div>
          </div>

        </div>
      </div>

      <!-- ===== FORMULARIO TARJETA ===== -->
      <div class="payment-form" *ngIf="metodoPagoSeleccionado === 'Tarjeta'">
        <div class="card-container p-3 rounded mb-3">
          <h6 class="mb-3"><i class="fa-solid fa-credit-card me-2"></i>Datos de la Tarjeta</h6>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Número de Tarjeta</label>
              <input type="text" class="form-control" [ngModel]="tarjetaNumero" (input)="formatearTarjeta($event)"
                placeholder="1234 5678 9012 3456" maxlength="19">
            </div>
            <div class="col-12">
              <label class="form-label">Nombre del Titular</label>
              <input type="text" class="form-control" [(ngModel)]="tarjetaNombre" placeholder="JUAN PEREZ"
                style="text-transform: uppercase;">
            </div>
            <div class="col-6">
              <label class="form-label">Vencimiento</label>
              <input type="text" class="form-control" [ngModel]="tarjetaExpiracion"
                (input)="formatearExpiracion($event)" placeholder="MM/AA" maxlength="5">
            </div>
            <div class="col-6">
              <label class="form-label">CVV</label>
              <input type="password" class="form-control" [(ngModel)]="tarjetaCVV" placeholder="123" maxlength="4">
            </div>
          </div>
          <div class="mt-3 text-center">
            <img
              src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/200px-Visa_Inc._logo.svg.png"
              alt="Visa" style="height: 25px; margin-right: 10px;">
            <img
              src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/200px-Mastercard-logo.svg.png"
              alt="Mastercard" style="height: 25px;">
          </div>
        </div>
      </div>

      <!-- ===== FORMULARIO TRANSFERENCIA ===== -->
      <div class="payment-form" *ngIf="metodoPagoSeleccionado === 'Transferencia'">
        <div class="transfer-container p-3 rounded mb-3">
          <h6 class="mb-3"><i class="fa-solid fa-building-columns me-2"></i>Transferencia Bancaria</h6>
          <div class="alert alert-secondary mb-3">
            <p class="mb-1"><strong>Cuenta BCP:</strong> 123-456789-0-12</p>
            <p class="mb-1"><strong>Cuenta Interbank:</strong> 987-654321-0-98</p>
            <p class="mb-0"><strong>CCI:</strong> 00212312345678901234</p>
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="fa-solid fa-hashtag me-1"></i>Número de Operación</label>
            <input type="text" class="form-control" [(ngModel)]="transferenciaReferencia" placeholder="Ej: 123456789">
          </div>
        </div>
      </div>

      <!-- Mensaje de estado -->
      <div *ngIf="mensajePago" class="alert" [ngClass]="{'alert-success': pagoExitoso, 'alert-danger': !pagoExitoso}">
        <i class="fa-solid" [ngClass]="{'fa-check-circle': pagoExitoso, 'fa-exclamation-circle': !pagoExitoso}"></i>
        {{ mensajePago }}
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarPagoModal()" [disabled]="procesandoPago">Cancelar</button>
      <button class="btn btn-success" (click)="confirmarPago()" [disabled]="procesandoPago || pagoExitoso">
        <i class="fa-solid fa-check me-2" *ngIf="!procesandoPago"></i>
        <span class="spinner-border spinner-border-sm me-2" *ngIf="procesandoPago"></span>
        {{ procesandoPago ? 'Procesando...' : 'Confirmar Pago' }}
      </button>
    </div>
  </div>
</div>

<!-- ========== MODAL CANCELAR RESERVA ========== -->
<div class="modal-overlay" *ngIf="showCancelarModal" (click)="cerrarCancelarModal()">
  <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header bg-danger text-white">
      <h5><i class="fa-solid fa-exclamation-triangle me-2"></i>Cancelar Reserva</h5>
      <button class="btn-close btn-close-white" (click)="cerrarCancelarModal()"></button>
    </div>
    <div class="modal-body text-center" *ngIf="reservaSeleccionada">
      <i class="fa-solid fa-ban text-danger fa-4x mb-3"></i>
      <p class="mb-2">¿Está seguro de que desea cancelar esta reserva?</p>
      <p class="text-muted small">
        <strong>{{ getVehiculoInfo(reservaSeleccionada) }}</strong><br>
        {{ reservaSeleccionada.fechaInicio }} - {{ reservaSeleccionada.fechaFin }}
      </p>
      <p class="text-danger small"><strong>Esta acción no se puede deshacer.</strong></p>
    </div>
    <div class="modal-footer justify-content-center">
      <button class="btn btn-secondary" (click)="cerrarCancelarModal()">No, Mantener</button>
      <button class="btn btn-danger" (click)="confirmarCancelacion()">
        <i class="fa-solid fa-ban me-2"></i>Sí, Cancelar
      </button>
    </div>
  </div>
</div>